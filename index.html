<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Management System</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .hidden {
            display: none;
        }
        #loginPage, #adminPage, #userPage {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage">
        <h2>Login</h2>
        <form id="loginForm">
            <label for="email">Email:</label>
            <input type="email" id="email" required>
            <label for="password">Password:</label>
            <input type="password" id="password" required>
            <button type="submit">Login</button>
        </form>
    </div>

    <!-- Admin Page -->
    <div id="adminPage">
        <h2>Admin Dashboard</h2>
        <button id="logoutButton">Logout</button>
        <div id="adminSection">
            <h3>Add Vehicle</h3>
            <form id="addVehicleForm">
                <label for="vehicleMake">Make:</label>
                <input type="text" id="vehicleMake" required>
                <label for="vehicleModel">Model:</label>
                <input type="text" id="vehicleModel" required>
                <label for="vehicleRegistration">Registration:</label>
                <input type="text" id="vehicleRegistration" required>
                <label for="projectName">Project Name:</label>
                <input type="text" id="projectName" required>
                <label for="startDate">Start Date:</label>
                <input type="text" id="startDate" required>
                <label for="startTime">Start Time:</label>
                <input type="time" id="startTime" required>
                <label for="endDate">End Date:</label>
                <input type="text" id="endDate" required>
                <label for="endTime">End Time:</label>
                <input type="time" id="endTime" required>
                <button type="submit">Add Vehicle</button>
            </form>

            <h3>Vehicle List</h3>
            <table id="adminVehicleTable">
                <thead>
                    <tr>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Registration</th>
                        <th>Project Name</th>
                        <th>Start Date</th>
                        <th>Start Time</th>
                        <th>End Date</th>
                        <th>End Time</th>
                        <th>Driver</th>
                        <th>Assigned To</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- User Page -->
    <div id="userPage">
        <h2>User Dashboard</h2>
        <button id="logoutButtonUser">Logout</button>
        <div id="userSection">
            <h3>Available Vehicles</h3>
            <table id="userVehicleTable">
                <thead>
                    <tr>
                        <th>Make</th>
                        <th>Model</th>
                        <th>Registration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <h3>My Requests</h3>
            <table id="myRequestsTable">
                <thead>
                    <tr>
                        <th>Vehicle</th>
                        <th>Status</th>
                        <th>Assigned Driver</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        // Initialize system
        const users = [
            { email: "TMokitimi@jhpiego.org", password: "password123", role: "admin" },
            { email: "user@jhpiego.org", password: "userpass", role: "user" }
        ];
        let vehicles = JSON.parse(localStorage.getItem("vehicles")) || [];
        let requests = JSON.parse(localStorage.getItem("requests")) || [];
        let currentUser = { email: "", role: "" };

        function initialize() {
            const loginPage = document.getElementById("loginPage");
            const adminPage = document.getElementById("adminPage");
            const userPage = document.getElementById("userPage");

            // Hide all pages initially
            loginPage.style.display = "none";
            adminPage.style.display = "none";
            userPage.style.display = "none";

            // Show login page if no user is logged in
            if (!currentUser.email) {
                loginPage.style.display = "block";
            } else if (currentUser.role === "admin") {
                adminPage.style.display = "block";
            } else if (currentUser.role === "user") {
                userPage.style.display = "block";
            }
        }

        // Login handling
        const loginForm = document.getElementById("loginForm");
        loginForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = { email: user.email, role: user.role };
                localStorage.setItem("currentUser", JSON.stringify(currentUser));
                initialize();
            } else {
                alert("Invalid credentials. Please try again.");
            }
        });

        // Logout handling for both Admin and User
        const logoutButtons = document.querySelectorAll("#logoutButton, #logoutButtonUser");
        logoutButtons.forEach(button => {
            button.addEventListener("click", function () {
                currentUser = { email: "", role: "" };
                localStorage.removeItem("currentUser");
                initialize();
            });
        });

        // Add Vehicle Handling for Admin
        const addVehicleForm = document.getElementById("addVehicleForm");
        addVehicleForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const vehicle = {
                id: generateId(),
                make: document.getElementById("vehicleMake").value.trim(),
                model: document.getElementById("vehicleModel").value.trim(),
                registration: document.getElementById("vehicleRegistration").value.trim(),
                projectName: document.getElementById("projectName").value,
                startDate: document.getElementById("startDate").value,
                startTime: document.getElementById("startTime").value,
                endDate: document.getElementById("endDate").value,
                endTime: document.getElementById("endTime").value,
                driver: "",
                assignedTo: ""
            };
            vehicles.push(vehicle);
            localStorage.setItem("vehicles", JSON.stringify(vehicles));
            addVehicleForm.reset();
            populateAdminVehicleTable();
        });

        // Generate a unique ID for each vehicle
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Populate Admin Vehicle Table
        function populateAdminVehicleTable() {
            const adminVehicleTableBody = document.querySelector("#adminVehicleTable tbody");
            adminVehicleTableBody.innerHTML = "";

            vehicles.forEach(vehicle => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${vehicle.make}</td>
                    <td>${vehicle.model}</td>
                    <td>${vehicle.registration}</td>
                    <td>${vehicle.projectName}</td>
                    <td>${vehicle.startDate}</td>
                    <td>${vehicle.startTime}</td>
                    <td>${vehicle.endDate}</td>
                    <td>${vehicle.endTime}</td>
                    <td>
                        <select data-vehicle-id="${vehicle.id}" class="driver-select">
                            <option value="">Select Driver</option>
                            ${users.filter(u => u.role === "fleetManager").map(u =>
                                `<option value="${u.email}" ${u.email === vehicle.driver ? "selected" : ""}>${u.email}</option>`
                            ).join("")}
                        </select>
                    </td>
                    <td>
                        <select data-vehicle-id="${vehicle.id}" class="assigned-to-select">
                            <option value="">Select User</option>
                            ${users.filter(u => u.role === "user").map(u =>
                                `<option value="${u.email}" ${u.email === vehicle.assignedTo ? "selected" : ""}>${u.email}</option>`
                            ).join("")}
                        </select>
                    </td>
                    <td>
                        <button class="deleteVehicleButton" data-vehicle-id="${vehicle.id}">Delete</button>
                    </td>
                `;
                adminVehicleTableBody.appendChild(row);
            });

            // Add event listeners for the select and delete buttons
            document.querySelectorAll(".driver-select").forEach(select => {
                select.addEventListener("change", function () {
                    const vehicleId = this.getAttribute("data-vehicle-id");
                    const selectedDriver = this.value;
                    vehicles = vehicles.map(vehicle => vehicle.id === vehicleId ? { ...vehicle, driver: selectedDriver } : vehicle);
                    localStorage.setItem("vehicles", JSON.stringify(vehicles));
                });
            });

            document.querySelectorAll(".assigned-to-select").forEach(select => {
                select.addEventListener("change", function () {
                    const vehicleId = this.getAttribute("data-vehicle-id");
                    const selectedUser = this.value;
                    vehicles = vehicles.map(vehicle => vehicle.id === vehicleId ? { ...vehicle, assignedTo: selectedUser } : vehicle);
                    localStorage.setItem("vehicles", JSON.stringify(vehicles));
                });
            });

            document.querySelectorAll(".deleteVehicleButton").forEach(button => {
                button.addEventListener("click", function () {
                    const vehicleId = this.getAttribute("data-vehicle-id");
                    vehicles = vehicles.filter(vehicle => vehicle.id !== vehicleId);
                    localStorage.setItem("vehicles", JSON.stringify(vehicles));
                    populateAdminVehicleTable();
                });
            });
        }

        // Initialize jQuery DatePicker for Start and End Date fields
        $(function () {
            $("#startDate, #endDate").datepicker({ dateFormat: "dd-mm-yy" });
        });

        // Load the current user on page load
        window.addEventListener("load", function () {
            const savedUser = localStorage.getItem("currentUser");
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            }
            initialize();
            populateAdminVehicleTable();
        });
    </script>
</body>
</html>
