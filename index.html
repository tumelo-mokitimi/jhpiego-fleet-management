<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jhpiego Vehicle Management System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        margin: 0;
        padding: 20px;
      }
      .header {
        display: flex;
        align-items: center;
      }
      .header img {
        width: auto;
        height: auto;
        margin-right: 35px;
      }
      .header h1 {
        margin: 0;
        color: #000000;
      }
      form,
      .section {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f2f2f2;
        border-radius: 25px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      input,
      button,
      select {
        margin: 5px 0;
        padding: 10px;
        width: 100%;
        border: 1px solid #efefef;
        border-radius: 5px;
        box-sizing: border-box;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
      }
      button {
        background-color: #016a63;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #039b91;
      }
      .button-group button {
        width: auto;
        margin-right: 5px;
      }
      .hidden {
        display: none;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  </head>
  <body>
    <div class="header">
      <img src="jhpiego_logo.png" alt="Jhpiego Logo" />
      <h1>Jhpiego Vehicle Management System</h1>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
        <input type="email" id="email" placeholder="Enter your email" required />
        <input type="password" id="password" placeholder="Enter your password" required />
        <button type="submit">Login</button>
    </form>

    <button id="logoutButton" class="hidden">Logout</button>
    <!-- Admin Section -->
    <div id="adminSection" class="hidden">
      <!-- Add Vehicle Form -->
      <div class="section">
        <h2>Add New Vehicle</h2>
        <form id="addVehicleForm">
          <input
            type="text"
            id="vehicleMake"
            placeholder="Vehicle Make"
            required
          />
          <input
            type="text"
            id="vehicleModel"
            placeholder="Vehicle Model"
            required
          />
          <input
            type="text"
            id="vehicleRegistration"
            placeholder="Vehicle Registration"
            required
          />
          <select id="projectName" required>
            <option value="" disabled selected>Select Project</option>
            <option value="CUT-TB">CUT-TB</option>
            <option value="MOSAIC">MOSAIC</option>
            <option value="RISE">RISE</option>
            <option value="MATRIX">MATRIX</option>
          </select>
          <input type="date" id="startDate" placeholder="Start Date" required />
          <input type="time" id="startTime" placeholder="Start Time" required />
          <input type="date" id="endDate" placeholder="End Date" required />
          <input type="time" id="endTime" placeholder="End Time" required />
          <select id="driver" required>
            <option value="" disabled selected>Select Driver</option>
            <option value="Driver 1">Driver 1</option>
            <option value="Driver 2">Driver 2</option>
            <option value="Driver 3">Driver 3</option>
          </select>
          <select id="assignedTo" required>
            <option value="" disabled selected>Select User</option>
            <!-- Populate this dynamically with users -->
          </select>
          <button type="submit">Add Vehicle</button>
        </form>
      </div>

      <!-- Vehicle List with Driver Assignment -->
      <div class="section">
        <h2>Vehicle List</h2>
        <table id="adminVehicleTable">
          <thead>
            <tr>
              <th>Make</th>
              <th>Model</th>
              <th>Registration</th>
              <th>Project</th>
              <th>Start Date</th>
              <th>Start Time</th>
              <th>End Date</th>
              <th>End Time</th>
              <th>Driver</th>
              <th>Assigned To</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Vehicles will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Section -->
    <div id="userSection" class="hidden">
      <!-- Available Vehicles -->
      <div class="section">
        <h2>Available Vehicles</h2>
        <table id="userVehicleTable">
          <thead>
            <tr>
              <th>Make</th>
              <th>Model</th>
              <th>Registration</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Available vehicles will be populated here -->
          </tbody>
        </table>
      </div>

      <!-- My Requests -->
      <div class="section">
        <h2>My Requests</h2>
        <table id="myRequestsTable">
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Status</th>
              <th>Assigned Driver</th>
              <th>Start Date</th>
              <th>End Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- User's requests will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB-QIKLsi4zXR0pqfEEemZnueGfLABDKQI",
        authDomain: "jhpiego-fleet-management.firebaseapp.com",
        projectId: "jhpiego-fleet-management",
        storageBucket: "gs://jhpiego-fleet-management.appspot.com",
        messagingSenderId: "124165831020",
        appId: "1:124165831020:web:0eb43029b699b61da2db49",
        measurementId: "G-6B53Y4JNVG"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Data Structures
      const users = [
        { email: "TMokitimi@jhpiego.org", role: "user" },
        { email: "MMatete@jhpiego.org", role: "user" },
        { email: "TNtelane@jhpiego.org", role: "user" },
        { email: "SMpalami@jhpiego.org", role: "user" },
        { email: "MShoba@jhpiego.org", role: "user" },
        { email: "TMolapo@jhpiego.org", role: "user" },
        { email: "RSoothoane@jhpiego.org", role: "user" },
        { email: "PMoshoeshoe@jhpiego.org", role: "user" },
        { email: "MTuoane@jhpiego.org", role: "user" },
        { email: "MNkongoane@jhpiego.org", role: "user" },
        { email: "fleetmanager@jhpiego.org", role: "fleetManager" },
      ];
      let currentUser = { email: "", role: "" };

      // Utility Functions
      function generateId() {
        return "_" + Math.random().toString(36).substr(2, 9);
      }

      // Populate User Dropdown in Add Vehicle Form
      function populateUserDropdown() {
        const assignedToSelect = document.getElementById("assignedTo");
        assignedToSelect.innerHTML = '<option value="" disabled selected>Select User</option>';

        users.forEach((user) => {
          const option = document.createElement("option");
          option.value = user.email;
          option.textContent = user.email;
          assignedToSelect.appendChild(option);
        });
      }

      // Handle Login
      document.getElementById("loginForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        // Simulate Authentication
        const user = users.find((user) => user.email === email);

        if (user) {
          currentUser = user;
          document.getElementById("loginForm").classList.add("hidden");
          document.getElementById("logoutButton").classList.remove("hidden");

          if (currentUser.role === "fleetManager") {
            document.getElementById("adminSection").classList.remove("hidden");
            populateUserDropdown();
          } else {
            document.getElementById("userSection").classList.remove("hidden");
          }
        } else {
          alert("User not found");
        }
      });

      // Handle Logout
      document.getElementById("logoutButton").addEventListener("click", () => {
        currentUser = { email: "", role: "" };
        document.getElementById("loginForm").classList.remove("hidden");
        document.getElementById("logoutButton").classList.add("hidden");
        document.getElementById("adminSection").classList.add("hidden");
        document.getElementById("userSection").classList.add("hidden");
      });

      // Handle Add Vehicle
      document.getElementById("addVehicleForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const vehicleMake = document.getElementById("vehicleMake").value;
        const vehicleModel = document.getElementById("vehicleModel").value;
        const vehicleRegistration = document.getElementById("vehicleRegistration").value;
        const projectName = document.getElementById("projectName").value;
        const startDate = document.getElementById("startDate").value;
        const startTime = document.getElementById("startTime").value;
        const endDate = document.getElementById("endDate").value;
        const endTime = document.getElementById("endTime").value;
        const driver = document.getElementById("driver").value;
        const assignedTo = document.getElementById("assignedTo").value;

        const vehicleId = generateId();

        const vehicleData = {
          vehicleId,
          vehicleMake,
          vehicleModel,
          vehicleRegistration,
          projectName,
          startDate,
          startTime,
          endDate,
          endTime,
          driver,
          assignedTo,
        };

        db.collection("vehicles").doc(vehicleId).set(vehicleData)
          .then(() => {
            alert("Vehicle added successfully!");
            populateAdminVehicleTable();
            document.getElementById("addVehicleForm").reset();
          })
          .catch((error) => {
            console.error("Error adding vehicle: ", error);
          });
      });

      // Populate Admin Vehicle Table
      function populateAdminVehicleTable() {
        db.collection("vehicles").get().then((querySnapshot) => {
          const vehicleTableBody = document.getElementById("adminVehicleTable").getElementsByTagName("tbody")[0];
          vehicleTableBody.innerHTML = "";

          querySnapshot.forEach((doc) => {
            const vehicleData = doc.data();
            const row = vehicleTableBody.insertRow();

            row.insertCell(0).textContent = vehicleData.vehicleMake;
            row.insertCell(1).textContent = vehicleData.vehicleModel;
            row.insertCell(2).textContent = vehicleData.vehicleRegistration;
            row.insertCell(3).textContent = vehicleData.projectName;
            row.insertCell(4).textContent = vehicleData.startDate;
            row.insertCell(5).textContent = vehicleData.startTime;
            row.insertCell(6).textContent = vehicleData.endDate;
            row.insertCell(7).textContent = vehicleData.endTime;
            row.insertCell(8).textContent = vehicleData.driver;
            row.insertCell(9).textContent = vehicleData.assignedTo;

            const actionsCell = row.insertCell(10);
            const editButton = document.createElement("button");
            editButton.textContent = "Edit";
            editButton.addEventListener("click", () => editVehicle(doc.id));
            actionsCell.appendChild(editButton);

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", () => deleteVehicle(doc.id));
            actionsCell.appendChild(deleteButton);
          });
        });
      }

      // Edit Vehicle
      function editVehicle(vehicleId) {
        // Implement Edit functionality here (e.g., populate form fields with vehicle data)
      }

      // Delete Vehicle
      function deleteVehicle(vehicleId) {
        if (confirm("Are you sure you want to delete this vehicle?")) {
          db.collection("vehicles").doc(vehicleId).delete()
            .then(() => {
              alert("Vehicle deleted successfully!");
              populateAdminVehicleTable();
            })
            .catch((error) => {
              console.error("Error deleting vehicle: ", error);
            });
        }
      }

      // Populate User Vehicle Table (Available Vehicles)
      function populateUserVehicleTable() {
        db.collection("vehicles").where("assignedTo", "==", "").get()
          .then((querySnapshot) => {
            const vehicleTableBody = document.getElementById("userVehicleTable").getElementsByTagName("tbody")[0];
            vehicleTableBody.innerHTML = "";

            querySnapshot.forEach((doc) => {
              const vehicleData = doc.data();
              const row = vehicleTableBody.insertRow();

              row.insertCell(0).textContent = vehicleData.vehicleMake;
              row.insertCell(1).textContent = vehicleData.vehicleModel;
              row.insertCell(2).textContent = vehicleData.vehicleRegistration;

              const actionsCell = row.insertCell(3);
              const requestButton = document.createElement("button");
              requestButton.textContent = "Request";
              requestButton.addEventListener("click", () => requestVehicle(doc.id));
              actionsCell.appendChild(requestButton);
            });
          });
      }

      // Request Vehicle
      function requestVehicle(vehicleId) {
        db.collection("vehicles").doc(vehicleId).update({
          assignedTo: currentUser.email,
        })
          .then(() => {
            alert("Vehicle requested successfully!");
            populateUserVehicleTable();
            populateMyRequestsTable();
          })
          .catch((error) => {
            console.error("Error requesting vehicle: ", error);
          });
      }

      // Populate My Requests Table
      function populateMyRequestsTable() {
        db.collection("vehicles").where("assignedTo", "==", currentUser.email).get()
          .then((querySnapshot) => {
            const requestsTableBody = document.getElementById("myRequestsTable").getElementsByTagName("tbody")[0];
            requestsTableBody.innerHTML = "";

            querySnapshot.forEach((doc) => {
              const vehicleData = doc.data();
              const row = requestsTableBody.insertRow();

              row.insertCell(0).textContent = vehicleData.vehicleMake + " " + vehicleData.vehicleModel;
              row.insertCell(1).textContent = "Pending"; // Placeholder, you can implement actual status
              row.insertCell(2).textContent = vehicleData.driver;
              row.insertCell(3).textContent = vehicleData.startDate;
              row.insertCell(4).textContent = vehicleData.endDate;
            });
          });
      }

      // Initial Data Load
      if (currentUser.role === "fleetManager") {
        populateAdminVehicleTable();
      } else if (currentUser.role === "user") {
        populateUserVehicleTable();
        populateMyRequestsTable();
      }

      $(function () {
        $("#startDate, #endDate").datepicker({
          dateFormat: "dd-mm-yy",
        });
      });
    </script>
  </body>
</html>
