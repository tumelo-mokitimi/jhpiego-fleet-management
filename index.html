<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jhpiego Vehicle Management System</title>
  <style>
    /* Styles remain unchanged */
    /* ... */
  </style>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
</head>
<body>
  <div class="header">
    <img src="jhpiego_logo.png" alt="Jhpiego Logo" />
    <h1>Jhpiego Vehicle Management System</h1>
  </div>

  <!-- Login Form -->
  <form id="loginForm">
    <input type="email" id="email" placeholder="Enter your email" required />
    <input type="password" id="password" placeholder="Enter your password" required />
    <button type="submit">Login</button>
  </form>

  <button id="logoutButton" class="hidden">Logout</button>

  <!-- Admin Section -->
  <div id="adminSection" class="hidden">
    <!-- Add Vehicle Form -->
    <div class="section">
      <h2>Add New Vehicle</h2>
      <form id="addVehicleForm">
        <input type="text" id="vehicleMake" placeholder="Vehicle Make" required />
        <input type="text" id="vehicleModel" placeholder="Vehicle Model" required />
        <input type="text" id="vehicleRegistration" placeholder="Vehicle Registration" required />
        <input type="text" id="destination" placeholder="Destination" required /> <!-- New Destination Input -->
        <select id="projectName" required>
          <option value="" disabled selected>Select Project</option>
          <option value="CUT-TB">CUT-TB</option>
          <option value="MOSAIC">MOSAIC</option>
          <option value="RISE">RISE</option>
          <option value="MATRIX">MATRIX</option>
        </select>
        <input type="date" id="startDate" placeholder="Start Date" required />
        <input type="time" id="startTime" placeholder="Start Time" required />
        <input type="date" id="endDate" placeholder="End Date" required />
        <input type="time" id="endTime" placeholder="End Time" required />
        <button type="submit">Add Vehicle</button>
      </form>
    </div>

    <!-- Vehicle List with Driver Assignment -->
    <div class="section">
      <h2>Vehicle List</h2>
      <table id="adminVehicleTable">
        <thead>
          <tr>
            <th>Make</th>
            <th>Model</th>
            <th>Registration</th>
            <th>Destination</th> <!-- New Destination Column -->
            <th>Project</th>
            <th>Start Date</th>
            <th>Start Time</th>
            <th>End Date</th>
            <th>End Time</th>
            <th>Driver</th>
            <th>Assigned To</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Vehicles will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- User Section -->
  <div id="userSection" class="hidden">
    <!-- Available Vehicles -->
    <div class="section">
      <h2>Available Vehicles</h2>
      <table id="userVehicleTable">
        <thead>
          <tr>
            <th>Make</th>
            <th>Model</th>
            <th>Registration</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Available vehicles will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- My Requests -->
    <div class="section">
      <h2>My Requests</h2>
      <table id="myRequestsTable">
        <thead>
          <tr>
            <th>Vehicle</th>
            <th>Status</th>
            <th>Assigned Driver</th>
            <th>Start Date</th>
            <th>End Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- User's requests will be populated here -->
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    // Data Structures
    const vehicles = JSON.parse(localStorage.getItem("vehicles")) || [];
    const requests = JSON.parse(localStorage.getItem("requests")) || [];
    const users = [
      { email: "TMokitimi@jhpiego.org", role: "user" },
      // Other users
    ];
    let currentUser = { email: "", role: "" };

    // Utility Functions
    function generateId() {
      return "_" + Math.random().toString(36).substr(2, 9);
    }

    // Initialize the system
    function initialize() {
      populateAdminVehicleTable();
      populateUserVehicleTable();
      populateMyRequestsTable();
    }

    // Login Handling
    const loginForm = document.getElementById("loginForm");
    const adminSection = document.getElementById("adminSection");
    const userSection = document.getElementById("userSection");
    const logoutButton = document.getElementById("logoutButton");

    loginForm.addEventListener("submit", function (event) {
      event.preventDefault();
      const emailInput = document.getElementById("email").value.trim();
      const passwordInput = document.getElementById("password").value.trim();

      if (!emailInput.endsWith("@jhpiego.org")) {
        alert("Only @jhpiego.org emails are allowed.");
        return;
      }

      currentUser.email = emailInput;
      const user = users.find((u) => u.email === emailInput);

      if (!user || passwordInput !== "password") {
        alert("Invalid credentials.");
        return;
      }

      currentUser.role = user.role;
      if (currentUser.role === "fleetManager") {
        adminSection.classList.remove("hidden");
        userSection.classList.add("hidden");
        populateAdminVehicleTable();
      } else {
        userSection.classList.remove("hidden");
        adminSection.classList.add("hidden");
        populateUserVehicleTable();
        populateMyRequestsTable();
      }

      loginForm.classList.add("hidden");
      logoutButton.classList.remove("hidden");
    });

    // Logout Handling
    logoutButton.addEventListener("click", function () {
      currentUser = { email: "", role: "" };
      loginForm.reset();
      loginForm.classList.remove("hidden");
      logoutButton.classList.add("hidden");
      adminSection.classList.add("hidden");
      userSection.classList.add("hidden");
    });

    // Add Vehicle Handling
    const addVehicleForm = document.getElementById("addVehicleForm");

    addVehicleForm.addEventListener("submit", function (event) {
      event.preventDefault();
      const vehicleMake = document.getElementById("vehicleMake").value.trim();
      const vehicleModel = document.getElementById("vehicleModel").value.trim();
      const vehicleRegistration = document.getElementById("vehicleRegistration").value.trim();
      const destination = document.getElementById("destination").value.trim(); // New Destination Value
      const projectName = document.getElementById("projectName").value;
      const startDate = document.getElementById("startDate").value;
      const startTime = document.getElementById("startTime").value;
      const endDate = document.getElementById("endDate").value;
      const endTime = document.getElementById("endTime").value;

      const newVehicle = {
        id: generateId(),
        make: vehicleMake,
        model: vehicleModel,
        registration: vehicleRegistration,
        destination: destination, // Include Destination in New Vehicle
        project: projectName,
        startDate: startDate,
        startTime: startTime,
        endDate: endDate,
        endTime: endTime,
        driver: "",
        assignedTo: "",
      };

      vehicles.push(newVehicle);
      localStorage.setItem("vehicles", JSON.stringify(vehicles));
      populateAdminVehicleTable();
      addVehicleForm.reset();
    });

    // Populate Admin Vehicle Table
    function populateAdminVehicleTable() {
      const adminVehicleTableBody = document.querySelector("#adminVehicleTable tbody");
      adminVehicleTableBody.innerHTML = "";

      vehicles.forEach(function (vehicle) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${vehicle.make}</td>
          <td>${vehicle.model}</td>
          <td contenteditable="true" class="editable" data-id="${vehicle.id}" data-field="registration">${vehicle.registration}</td>
          <td contenteditable="true" class="editable" data-id="${vehicle.id}" data-field="destination">${vehicle.destination}</td> <!-- Editable Destination -->
          <td>${vehicle.project}</td>
          <td>${vehicle.startDate}</td>
          <td>${vehicle.startTime}</td>
          <td>${vehicle.endDate}</td>
          <td>${vehicle.endTime}</td>
          <td><input type="text" class="driver-input" value="${vehicle.driver}" data-id="${vehicle.id}" /></td>
          <td><input type="text" class="assigned-to-input" value="${vehicle.assignedTo}" data-id="${vehicle.id}" /></td>
          <td>
            <button class="delete-btn" data-id="${vehicle.id}">Delete</button>
          </td>
        `;

        adminVehicleTableBody.appendChild(tr);
      });

      // Add event listeners for editing and deleting vehicles
      attachEditableEvents();
      attachDeleteEvents();
    }

    // Attach Events for Editable Fields
    function attachEditableEvents() {
      document.querySelectorAll(".editable").forEach(function (element) {
        element.addEventListener("blur", function (event) {
          const id = event.target.dataset.id;
          const field = event.target.dataset.field;
          const value = event.target.textContent.trim();
          const vehicle = vehicles.find((v) => v.id === id);

          if (vehicle) {
            vehicle[field] = value;
            localStorage.setItem("vehicles", JSON.stringify(vehicles));
          }
        });
      });
    }

    // Attach Events for Deleting Vehicles
    function attachDeleteEvents() {
      document.querySelectorAll(".delete-btn").forEach(function (button) {
        button.addEventListener("click", function () {
          const id = button.dataset.id;
          const index = vehicles.findIndex((v) => v.id === id);
          if (index !== -1) {
            vehicles.splice(index, 1);
            localStorage.setItem("vehicles", JSON.stringify(vehicles));
            populateAdminVehicleTable();
          }
        });
      });
    }

    // Populate User Vehicle Table
    function populateUserVehicleTable() {
      const userVehicleTableBody = document.querySelector("#userVehicleTable tbody");
      userVehicleTableBody.innerHTML = "";

      vehicles.forEach(function (vehicle) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${vehicle.make}</td>
          <td>${vehicle.model}</td>
          <td>${vehicle.registration}</td>
          <td>
            <button class="request-btn" data-id="${vehicle.id}">Request</button>
          </td>
        `;

        userVehicleTableBody.appendChild(tr);
      });

      // Add event listeners for requesting vehicles
      attachRequestEvents();
    }

    // Attach Events for Requesting Vehicles
    function attachRequestEvents() {
      document.querySelectorAll(".request-btn").forEach(function (button) {
        button.addEventListener("click", function () {
          const id = button.dataset.id;
          const vehicle = vehicles.find((v) => v.id === id);

          if (vehicle) {
            const newRequest = {
              id: generateId(),
              vehicleId: vehicle.id,
              vehicle: `${vehicle.make} ${vehicle.model} (${vehicle.registration})`,
              status: "Pending",
              assignedDriver: "",
              startDate: vehicle.startDate,
              endDate: vehicle.endDate,
            };

            requests.push(newRequest);
            localStorage.setItem("requests", JSON.stringify(requests));
            populateMyRequestsTable();
          }
        });
      });
    }

    // Populate My Requests Table
    function populateMyRequestsTable() {
      const myRequestsTableBody = document.querySelector("#myRequestsTable tbody");
      myRequestsTableBody.innerHTML = "";

      const userRequests = requests.filter((r) => r.vehicleId && vehicles.find((v) => v.id === r.vehicleId));

      userRequests.forEach(function (request) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${request.vehicle}</td>
          <td>${request.status}</td>
          <td>${request.assignedDriver}</td>
          <td>${request.startDate}</td>
          <td>${request.endDate}</td>
        `;

        myRequestsTableBody.appendChild(tr);
      });
    }

    // Initialize the system on page load
    initialize();
  </script>
</body>
</html>
