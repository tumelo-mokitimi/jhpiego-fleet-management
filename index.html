<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jhpiego Vehicle Management System</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        margin: 0;
        padding: 20px;
      }
      .header {
        display: flex;
        align-items: center;
      }
      .header img {
        width: auto;
        height: auto;
        margin-right: 35px;
      }
      .header h1 {
        margin: 0;
        color: #000000;
      }
      form,
      .section {
        margin-bottom: 20px;
        padding: 20px;
        background-color: #f2f2f2;
        border-radius: 25px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      input,
      button,
      select {
        margin: 5px 0;
        padding: 10px;
        width: 100%;
        border: 1px solid #efefef;
        border-radius: 5px;
        box-sizing: border-box;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
      }
      button {
        background-color: #016a63;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #039b91;
      }
      .button-group button {
        width: auto;
        margin-right: 5px;
      }
      .hidden {
        display: none;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  </head>
  <body>
    <div class="header">
      <img src="jhpiego_logo.png" alt="Jhpiego Logo" />
      <h1>Jhpiego Vehicle Management System</h1>
    </div>

    <!-- Login Form -->
    <form id="loginForm">
      <input type="email" id="email" placeholder="Enter your email" required />
      <input
        type="password"
        id="password"
        placeholder="Enter your password"
        required
      />
      <button type="submit">Login</button>
    </form>

    <button id="logoutButton" class="hidden">Logout</button>

    <!-- Admin Section -->
    <div id="adminSection" class="hidden">
      <!-- Add Vehicle Form -->
      <div class="section">
        <h2>Add New Vehicle</h2>
        <form id="addVehicleForm">
          <input
            type="text"
            id="vehicleMake"
            placeholder="Vehicle Make"
            required
          />
          <input
            type="text"
            id="vehicleModel"
            placeholder="Vehicle Model"
            required
          />
          <input
            type="text"
            id="vehicleRegistration"
            placeholder="Vehicle Registration"
            required
          />
          <select id="projectName" required>
            <option value="" disabled selected> Select Project</option>
            <option value="CUT-TB">CUT-TB</option>
            <option value="MOSAIC">MOSAIC</option>
            <option value="RISE">RISE</option>
            <option value="MATRIX">MATRIX</option>
          </select>
          <input type="date" id="startDate" placeholder="Start Date" required />
          <input type="time" id="startTime" placeholder="Start Time" required />
          <input type="date" id="endDate" placeholder="End Date" required />
          <input type="time" id="endTime" placeholder="End Time" required />
          <button type="submit">Add Vehicle</button>
        </form>
      </div>

      <!-- Vehicle List with Driver Assignment -->
      <div class="section">
        <h2>Vehicle List</h2>
        <table id="adminVehicleTable">
          <thead>
            <tr>
              <th>Make</th>
              <th>Model</th>
              <th>Registration</th>
              <th>Project</th>
              <th>Start Date</th>
              <th>Start Time</th>
              <th>End Date</th>
              <th>End Time</th>
              <th>Driver</th>
              <th>Assigned To</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Vehicles will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- User Section -->
    <div id="userSection" class="hidden">
      <!-- Available Vehicles -->
      <div class="section">
        <h2>Available Vehicles</h2>
        <table id="userVehicleTable">
          <thead>
            <tr>
              <th>Make</th>
              <th>Model</th>
              <th>Registration</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Available vehicles will be populated here -->
          </tbody>
        </table>
      </div>

      <!-- My Requests -->
      <div class="section">
        <h2>My Requests</h2>
        <table id="myRequestsTable">
          <thead>
            <tr>
              <th>Vehicle</th>
              <th>Status</th>
              <th>Assigned Driver</th>
              <th>Start Date</th>
              <th>End Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- User's requests will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB-QIKLsi4zXR0pqfEEemZnueGfLABDKQI",
        authDomain: "jhpiego-fleet-management.firebaseapp.com",
        projectId: "jhpiego-fleet-management",
        storageBucket: "jhpiego-fleet-management.appspot.com",
        messagingSenderId: "124165831020",
        appId: "1:124165831020:web:0eb43029b699b61da2db49",
        measurementId: "G-6B53Y4JNVG"
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Data Structures
      const users = [
        { email: "TMokitimi@jhpiego.org", role: "user" },
        { email: "MMatete@jhpiego.org", role: "user" },
        { email: "TNtelane@jhpiego.org", role: "user" },
        { email: "SMpalami@jhpiego.org", role: "user" },
        { email: "MShoba@jhpiego.org", role: "user" },
        { email: "TMolapo@jhpiego.org", role: "user" },
        { email: "RSoothoane@jhpiego.org", role: "user" },
        { email: "PMoshoeshoe@jhpiego.org", role: "user" },
        { email: "MTuoane@jhpiego.org", role: "user" },
        { email: "MNkongoane@jhpiego.org", role: "user" },
        { email: "fleetmanager@jhpiego.org", role: "fleetManager" },
      ];
      let currentUser = { email: "", role: "" };

      // Utility Functions
      function generateId() {
        return "_" + Math.random().toString(36).substr(2, 9);
      }

      // Initialize the system
      function initialize() {
        populateAdminVehicleTable();
        populateUserVehicleTable();
        populateMyRequestsTable();
      }

      // Login Handling
      const loginForm = document.getElementById("loginForm");
      const adminSection = document.getElementById("adminSection");
      const userSection = document.getElementById("userSection");
      const logoutButton = document.getElementById("logoutButton");

      loginForm.addEventListener("submit", async function (event) {
  event.preventDefault();

  const emailInput = document.getElementById("email").value.trim();
  const passwordInput = document.getElementById("password").value.trim();

  try {
    // Sign in using Firebase Authentication
    const userCredential = await firebase.auth().signInWithEmailAndPassword(emailInput, passwordInput);
    const user = userCredential.user;

    // Fetch the user data from Firestore
    const userDoc = await db.collection("users").doc(user.uid).get();

    if (userDoc.exists) {
      const userData = userDoc.data();
      currentUser = { email: userData.email, role: userData.role };

      // Hide the login form and show the logout button
      loginForm.classList.add("hidden");
      logoutButton.classList.remove("hidden");

      // Show the appropriate section based on the user's role
      if (currentUser.role === "fleetManager") {
        adminSection.classList.remove("hidden");
        populateAdminVehicleTable();
      } else {
        userSection.classList.remove("hidden");
        populateUserVehicleTable();
        populateMyRequestsTable();
      }
    } else {
      alert("User data not found in the database.");
    }
  } catch (error) {
    console.error("Error logging in:", error.message);
    alert("Login failed: " + error.message);
  }
});

logoutButton.addEventListener("click", function () {
  firebase.auth().signOut().then(() => {
    // Reset the current user
    currentUser = { email: "", role: "" };

    // Show login form and handle login and logout actions

function populateAdminVehicleTable() {
  const tableBody = document.querySelector("#adminVehicleTable tbody");
  tableBody.innerHTML = ""; // Clear existing table rows

  db.collection("vehicles").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const vehicle = doc.data();
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${vehicle.make}</td>
        <td>${vehicle.model}</td>
        <td>${vehicle.registration}</td>
        <td>${vehicle.project}</td>
        <td>${vehicle.startDate}</td>
        <td>${vehicle.startTime}</td>
        <td>${vehicle.endDate}</td>
        <td>${vehicle.endTime}</td>
        <td>${vehicle.driver}</td>
        <td>${vehicle.assignedTo}</td>
        <td>
          <button class="editButton" data-id="${doc.id}">Edit</button>
          <button class="deleteButton" data-id="${doc.id}">Delete</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    attachAdminTableEventListeners();
  }).catch((error) => {
    console.error("Error populating vehicle table:", error.message);
  });
}

function populateUserVehicleTable() {
  const tableBody = document.querySelector("#userVehicleTable tbody");
  tableBody.innerHTML = ""; // Clear existing table rows

  db.collection("vehicles").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const vehicle = doc.data();
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${vehicle.make}</td>
        <td>${vehicle.model}</td>
        <td>${vehicle.registration}</td>
        <td>
          <button class="requestButton" data-id="${doc.id}">Request</button>
        </td>
      `;
      tableBody.appendChild(row);
    });

    attachUserTableEventListeners();
  }).catch((error) => {
    console.error("Error populating user vehicle table:", error.message);
  });
}

function populateMyRequestsTable() {
  const tableBody = document.querySelector("#myRequestsTable tbody");
  tableBody.innerHTML = ""; // Clear existing table rows

  db.collection("requests").where("userEmail", "==", currentUser.email).get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      const request = doc.data();
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${request.vehicleMake} ${request.vehicleModel}</td>
        <td>${request.status}</td>
        <td>${request.driver}</td>
        <td>${request.startDate}</td>
        <td>${request.endDate}</td>
      `;
      tableBody.appendChild(row);
    });
  }).catch((error) => {
    console.error("Error populating my requests table:", error.message);
  });
}

function attachAdminTableEventListeners() {
  const editButtons = document.querySelectorAll(".editButton");
  const deleteButtons = document.querySelectorAll(".deleteButton");

  editButtons.forEach(button => {
    button.addEventListener("click", function () {
      const docId = this.dataset.id;
      // Fetch the document and populate the form for editing
      db.collection("vehicles").doc(docId).get().then((doc) => {
        if (doc.exists) {
          const vehicle = doc.data();
          document.getElementById("vehicleMake").value = vehicle.make;
          document.getElementById("vehicleModel").value = vehicle.model;
          document.getElementById("vehicleRegistration").value = vehicle.registration;
          document.getElementById("projectName").value = vehicle.project;
          document.getElementById("startDate").value = vehicle.startDate;
          document.getElementById("startTime").value = vehicle.startTime;
          document.getElementById("endDate").value = vehicle.endDate;
          document.getElementById("endTime").value = vehicle.endTime;

          // Update vehicle on form submit
          const addVehicleForm = document.getElementById("addVehicleForm");
          addVehicleForm.onsubmit = function (event) {
            event.preventDefault();
            updateVehicle(docId);
          };
        }
      }).catch((error) => {
        console.error("Error fetching vehicle data:", error.message);
      });
    });
  });

  deleteButtons.forEach(button => {
    button.addEventListener("click", function () {
      const docId = this.dataset.id;
      // Delete the vehicle document
      db.collection("vehicles").doc(docId).delete().then(() => {
        populateAdminVehicleTable();
      }).catch((error) => {
        console.error("Error deleting vehicle:", error.message);
      });
    });
  });
}

function attachUserTableEventListeners() {
  const requestButtons = document.querySelectorAll(".requestButton");

  requestButtons.forEach(button => {
    button.addEventListener("click", function () {
      const docId = this.dataset.id;
      // Fetch vehicle details and create a new request
      db.collection("vehicles").doc(docId).get().then((doc) => {
        if (doc.exists) {
          const vehicle = doc.data();
          const requestId = generateId();
          const newRequest = {
            id: requestId,
            userEmail: currentUser.email,
            vehicleMake: vehicle.make,
            vehicleModel: vehicle.model,
            status: "Pending",
            driver: "",
            startDate: vehicle.startDate,
            endDate: vehicle.endDate
          };

          db.collection("requests").doc(requestId).set(newRequest).then(() => {
            populateMyRequestsTable();
          }).catch((error) => {
            console.error("Error creating request:", error.message);
          });
        }
      }).catch((error) => {
        console.error("Error fetching vehicle data:", error.message);
      });
    });
  });
}

function updateVehicle(docId) {
  const vehicleData = {
    make: document.getElementById("vehicleMake").value,
    model: document.getElementById("vehicleModel").value,
    registration: document.getElementById("vehicleRegistration").value,
    project: document.getElementById("projectName").value,
    startDate: document.getElementById("startDate").value,
    startTime: document.getElementById("startTime").value,
    endDate: document.getElementById("endDate").value,
    endTime: document.getElementById("endTime").value,
  };

  db.collection("vehicles").doc(docId).update(vehicleData).then(() => {
    populateAdminVehicleTable();
    // Reset the form
    document.getElementById("addVehicleForm").reset();
  }).catch((error) => {
    console.error("Error updating vehicle:", error.message);
  });
}

// Initialize the app when the window loads
window.onload = function () {
  initialize();
};
    </script>
  </body>
</html>
