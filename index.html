<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jhpiego Vehicle Management System</title>
    <style> 
      /* Your existing styles here */
    </style>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
  </head>
  <body>
    <div class="header">
      <img src="jhpiego_logo.png" alt="Jhpiego Logo" />
      <h1>Jhpiego Vehicle Management System</h1>
    </div>

    <!-- Login Form -->
    <div id="loginDiv">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Enter Email"><br><br>
        <input type="password" id="password" placeholder="Enter Password"><br><br>
        <button onclick="login()">Login</button>
    </div>

    <!-- System Main Interface -->
    <div id="mainDiv" style="display:none;">
        <button onclick="logout()">Logout</button>
        <h2>Manage Vehicles</h2>
        
        <!-- Vehicle Management Table -->
        <table id="vehicleTable">
            <thead>
                <tr>
                    <th>Vehicle Registration</th>
                    <th>Project Name</th>
                    <th>Driver</th>
                    <th>Start Date</th>
                    <th>Start Time</th>
                    <th>End Date</th>
                    <th>End Time</th>
                    <th>Destination</th>
                    <th>Assigned To</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Vehicle rows will be dynamically populated -->
            </tbody>
        </table>

        <br>

        <!-- Add New Vehicle Form -->
        <h3>Add New Vehicle</h3>
        <input type="text" id="vehicleRegistration" placeholder="Vehicle Reg">
        <select id="driverDropdown">
        </select>
        <select id="projectDropdown">
        </select>
        <input type="date" id="startDate">
        <input type="time" id="startTime">
        <input type="date" id="endDate">
        <input type="time" id="endTime">
        <input type="text" id="destination" placeholder="Destination">
        <input type= "text" id="assignedTo" placeholde="Assignee">
        <button onclick="addVehicle()">Add Vehicle</button>

        <br><br>
        
        <!-- Dropdown to Select User to Assign Vehicle -->
        <select id="userDropdown">
            <!-- Users will be dynamically populated -->
        </select>
    </div>

    <script>
        // Sample users with roles for the system
        const users = [
          { email: "TMokitimi@jhpiego.org", role: "user" },
          { email: "MMatete@jhpiego.org", role: "user" },
          { email: "TNtelane@jhpiego.org", role: "user" },
          { email: "SMpalami@jhpiego.org", role: "user" },
          { email: "MShoba@jhpiego.org", role: "user" },
          { email: "TMolapo@jhpiego.org", role: "user" },
          { email: "RSoothoane@jhpiego.org", role: "user" },
          { email: "PMoshoeshoe@jhpiego.org", role: "user" },
          { email: "MTuoane@jhpiego.org", role: "user" },
          { email: "MNkongoane@jhpiego.org", role: "user" },
          { email: "fleetmanager@jhpiego.org", role: "fleetManager" },
        ];
        let currentUser = { email: "", role: "" };
        function generateId() {
        return "_" + Math.random().toString(36).substr(2, 9);
      }

      // Initialize the system
      function initialize() {
        populateAdminVehicleTable();
        populateUserVehicleTable();
        populateMyRequestsTable();
      }

      // Login Handling
      const loginForm = document.getElementById("loginForm");
      const adminSection = document.getElementById("adminSection");
      const userSection = document.getElementById("userSection");
      const logoutButton = document.getElementById("logoutButton");
  
      // Sample projects for the system
        const projects = [
            'CUT-TB',
            'RISE',
            'MOSAIC'
            'MATRIX'
        ];

      // Sample drivers for the system
        const drivers = [
            'Kagiso',
            'Mahloko',
            'Makhaola'
        ];

        // State management for logged-in user and vehicles
        let loggedInUser = null;
        let vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];

        // Load users and drivers into dropdowns
        window.onload = () => {
            const userDropdown = document.getElementById('userDropdown');
            users.forEach(user => {
                if (user.role === 'requester') {
                    let option = document.createElement('option');
                    option.value = user.email;
                    option.innerText = user.email;
                    userDropdown.appendChild(option);
                }
            });

            const driverDropdown = document.getElementById('driverDropdown');
            drivers.forEach(driver => {
                let option = document.createElement('option');
                option.value = driver;
                option.innerText = driver;
                driverDropdown.appendChild(option);
            });

            renderVehicles();
        };

        // Login function
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const user = users.find(u => u.email === email && u.password === password);

            if (user) {
                loggedInUser = user;
                document.getElementById('loginDiv').style.display = 'none';
                document.getElementById('mainDiv').style.display = 'block';

                if (user.role === 'fleet_manager') {
                    document.getElementById('mainDiv').classList.add('fleet-manager');
                } else {
                    document.getElementById('mainDiv').classList.remove('fleet-manager');
                }
            } else {
                alert('Invalid email or password');
            }
        }

        // Logout function
        function logout() {
            loggedInUser = null;
            document.getElementById('loginDiv').style.display = 'block';
            document.getElementById('mainDiv').style.display = 'none';
        }

        // Function to render vehicles in the table
        function renderVehicles() {
            const tbody = document.querySelector('#vehicleTable tbody');
            tbody.innerHTML = '';
            vehicles.forEach((vehicle, index) => {
                const tr = document.createElement('tr');

                tr.innerHTML = `
                    <td>${vehicle Registration}</td>
                    <td>$Project Name</td>
                    <td>$Driver</td>
                    <td>$Start Date</td>
                    <td>$Start Time</td>
                    <td>$End Date</td>
                    <td>$End Time</td>
                    <td>$Destination</td>
                    <td>$Assigned To</td>
                    <td>$Actions</td>
                    <td>
                        <select onchange="updateAssignedUser(${index}, this.value)">
                            ${users.filter(user => user.role === 'requester').map(user => `<option value="${user.email}" ${user.email === vehicle.assignedTo ? 'selected' : ''}>${user.email}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <button onclick="editVehicle(${index})">Edit</button>
                        <button onclick="deleteVehicle(${index})">Delete</button>
                    </td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Function to add a new vehicle
        function addVehicle() {
            const vehicleName = document.getElementById('vehicleName').value;
            const projectName = document.getElementById('projectDropdown').value;
            const driver = document.getElementById('driverDropdown').value;
            const startDate = document.getElementById('startDate').value;
            const startTime = document.getElementById('startTime').value;
            const endDate = document.getElementById('endDate').value;
            const endTime = document.getElementById('endTime').value;
            const destination = document.getElementById('destination').value;
            const assignedTo = document.getElementById('userDropdown').value;

            if (vehicleName && projectName && driver && startDate && startTime && endDate && endTime && destination && assignedTo) {
                vehicles.push({
                    name: vehicleName,
                    project: projectName,
                    driver: driver,
                    startDate: startDate,
                    startTime: startTime,
                    endDate: endDate,
                    endTime: endTime,
                    destination: destination,
                    assignedTo: assignedTo
                });
                localStorage.setItem('vehicles', JSON.stringify(vehicles));
                renderVehicles();
            } else {
                alert('Please fill out all fields.');
            }
        }

        // Function to update the assigned user
        function updateAssignedUser(index, user) {
            vehicles[index].assignedTo = user;
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
        }

        // Function to edit an existing vehicle
        function editVehicle(index) {
            const vehicle = vehicles[index];
            document.getElementById('vehicleName').value = vehicle.name;
            document.getElementById('projectDropdown').value = vehicle.project;
            document.getElementById('driverDropdown').value = vehicle.driver;
            document.getElementById('startDate').value = vehicle.startDate;
            document.getElementById('startTime').value = vehicle.startTime;
            document.getElementById('endDate').value = vehicle.endDate;
            document.getElementById('endTime').value = vehicle.endTime;
            document.getElementById('destination').value = vehicle.destination; // Load destination into the input
            document.getElementById('userDropdown').value = vehicle.assignedTo;

            // After editing, remove the original entry and update with the edited details
            vehicles.splice(index, 1);
        }

        // Function to delete a vehicle
        function deleteVehicle(index) {
            vehicles.splice(index, 1);
            localStorage.setItem('vehicles', JSON.stringify(vehicles));
            renderVehicles();
        }

    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $(document).ready(function () {
        // Initialize the datepickers
        $('#startDate').datepicker({
          dateFormat: 'dd-mm-yy',
        });
        $('#endDate').datepicker({
          dateFormat: 'dd-mm-yy',
        });
      });
    </script>
  </body>
</html>
